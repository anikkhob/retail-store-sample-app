name: CI/CD Matrix Build and Deploy

on:
  push:
    branches: [gitops]
    paths:
      - 'src/**'
  pull_request:
    branches: [gitops]
    paths:
      - 'src/**'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

jobs:
  # Job to detect which services have changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changes.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Define services and their paths
          declare -A services=(
            ["ui"]="src/ui"
            ["catalog"]="src/catalog"
            ["cart"]="src/cart"
            ["orders"]="src/orders"
            ["checkout"]="src/checkout"
          )
          
          # Check which services have changes
          changed_services=()
          for service in "${!services[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^${services[$service]}/"; then
              changed_services+=("$service")
              echo "‚úÖ Changes detected in $service service"
            fi
          done
          
          # Create matrix JSON
          if [ ${#changed_services[@]} -eq 0 ]; then
            echo "No service changes detected"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "matrix={}" >> $GITHUB_OUTPUT
          else
            echo "Services to build: ${changed_services[*]}"
            matrix_json=$(printf '%s\n' "${changed_services[@]}" | jq -R . | jq -s '{service: .}')
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          fi

  # Matrix job to build and deploy changed services
  build-and-deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up service variables
        id: vars
        run: |
          SERVICE="${{ matrix.service }}"
          ECR_REPOSITORY="retail-store-$SERVICE"
          IMAGE_TAG="${{ github.sha }}"
          
          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "ecr-repository=$ECR_REPOSITORY" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image-uri=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Create ECR repository if it doesn't exist
        run: |
          aws ecr describe-repositories --repository-names ${{ steps.vars.outputs.ecr-repository }} || \
          aws ecr create-repository --repository-name ${{ steps.vars.outputs.ecr-repository }}

      - name: Build Docker image
        run: |
          echo "üî® Building ${{ steps.vars.outputs.service }} service..."
          docker build -t ${{ steps.vars.outputs.image-uri }} ./src/${{ steps.vars.outputs.service }}/

      - name: Push image to ECR
        run: |
          echo "üöÄ Pushing ${{ steps.vars.outputs.service }} image to ECR..."
          docker push ${{ steps.vars.outputs.image-uri }}

      - name: Update Helm values
        run: |
          SERVICE="${{ steps.vars.outputs.service }}"
          IMAGE_TAG="${{ steps.vars.outputs.image-tag }}"
          VALUES_FILE="src/$SERVICE/chart/values.yaml"
          
          if [ -f "$VALUES_FILE" ]; then
            echo "üìù Updating $VALUES_FILE with new image tag: $IMAGE_TAG"
            
            # Update image tag in values.yaml
            sed -i "s/tag: .*/tag: \"$IMAGE_TAG\"/" "$VALUES_FILE"
            
            # Update repository if needed
            sed -i "s|repository: .*|repository: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/retail-store-$SERVICE|" "$VALUES_FILE"
            
            echo "‚úÖ Updated values.yaml for $SERVICE"
            cat "$VALUES_FILE"
          else
            echo "‚ö†Ô∏è Values file not found: $VALUES_FILE"
          fi

      - name: Commit and push updated values
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          SERVICE="${{ steps.vars.outputs.service }}"
          IMAGE_TAG="${{ steps.vars.outputs.image-tag }}"
          
          git add src/$SERVICE/chart/values.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit for $SERVICE"
          else
            git commit -m "üöÄ Update $SERVICE image to $IMAGE_TAG"
            git push
            echo "‚úÖ Pushed updated values for $SERVICE"
          fi

      - name: Trigger ArgoCD sync (optional)
        run: |
          echo "üîÑ Service ${{ steps.vars.outputs.service }} updated successfully!"
          echo "ArgoCD will automatically detect and sync the changes."
          echo "Image: ${{ steps.vars.outputs.image-uri }}"

  # Summary job
  deployment-summary:
    needs: [detect-changes, build-and-deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          if [ "${{ needs.detect-changes.outputs.has-changes }}" == "true" ]; then
            if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
              echo "‚úÖ All changed services deployed successfully!"
            else
              echo "‚ùå Some deployments failed. Check the logs above."
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è No service changes detected. Skipping deployment."
          fi
