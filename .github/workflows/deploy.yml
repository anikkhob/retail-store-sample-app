name: deploy
on:
  push:
    branches: [gitops]
    paths: ['src/**']
  workflow_dispatch:

env:
  aws_region: ${{ secrets.AWS_REGION }}

jobs:
  detect_changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      changed-services: ${{ steps.changes.outputs.changed-services }}
      matrix: ${{ steps.changes.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with: 
          fetch-depth: 2
      - name: Detect changed services
        id: changes
        run: |
          SERVICES=("ui" "catalog" "cart" "checkout" "orders")
          CHANGED_SERVICES=()
          
          for service in "${SERVICES[@]}"; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/$service/"; then
              CHANGED_SERVICES+=("$service")
            fi
          done
          
          if [ ${#CHANGED_SERVICES[@]} -eq 0 ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "matrix={}" >> $GITHUB_OUTPUT
            echo "changed-services=[]" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            MATRIX_JSON=$(printf '{"service":["%s"]}' "$(IFS='","'; echo "${CHANGED_SERVICES[*]}")") 
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
            echo "changed-services=[$(printf '"%s",' "${CHANGED_SERVICES[@]}" | sed 's/,$//')]" >> $GITHUB_OUTPUT
          fi     
  
  deploy:
    name: Deploy ${{ matrix.service }}
    needs: detect_changes
    if: needs.detect_changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix: ${{ fromJson(needs.detect_changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.aws_region }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Build and push ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          TAG="$(echo ${{ github.sha }} | cut -c1-7)"
          AWS_ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"
          ECR_REPO="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.aws_region }}.amazonaws.com/retail-store-${SERVICE}"
          
          # Create ECR repo if it doesn't exist
          aws ecr describe-repositories --repository-names "retail-store-${SERVICE}" 2>/dev/null || \
            aws ecr create-repository --repository-name "retail-store-${SERVICE}" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
          
          # Build and push
          docker build -t "${ECR_REPO}:${TAG}" -t "${ECR_REPO}:latest" "src/${SERVICE}/"
          docker push "${ECR_REPO}:${TAG}"
          docker push "${ECR_REPO}:latest"

      - name: Update Helm values for ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          TAG="$(echo ${{ github.sha }} | cut -c1-7)"
          AWS_ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"
          ECR_REPO="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.aws_region }}.amazonaws.com/retail-store-${SERVICE}"
          VALUES_FILE="src/${SERVICE}/chart/values.yaml"
          
          # Validate file exists
          if [[ ! -f "${VALUES_FILE}" ]]; then
            echo "âŒ Values file not found: ${VALUES_FILE}"
            exit 1
          fi
          
          # Show before state
          echo "ðŸ“‹ Before update (main service image):"
          grep -A3 "^image:" "${VALUES_FILE}" | head -4 || echo "No main image section found"
          
          # Create a backup
          cp "${VALUES_FILE}" "${VALUES_FILE}.backup"
          
          # Update only the main service image (first occurrence under 'image:' section)
          # This preserves infrastructure component images (mysql, redis, postgresql, rabbitmq, dynamodb)
          awk -v repo="${ECR_REPO}" -v tag="${TAG}" '
          BEGIN { in_main_image = 0; updated_repo = 0; updated_tag = 0 }
          /^image:/ { in_main_image = 1; print; next }
          in_main_image && /^[[:space:]]*repository:/ && !updated_repo { 
            print "  repository: " repo; updated_repo = 1; next 
          }
          in_main_image && /^[[:space:]]*tag:/ && !updated_tag { 
            print "  tag: \"" tag "\""; updated_tag = 1; next 
          }
          /^[a-zA-Z]/ && !/^image:/ { in_main_image = 0 }
          { print }
          ' "${VALUES_FILE}.backup" > "${VALUES_FILE}"    

      - name: Commit Helm changes for ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          TAG="$(echo ${{ github.sha }} | cut -c1-7)"
          
          git config --local user.email "gitops@github.com"
          git config --local user.name "GitOps Bot"
          
          if ! git diff --quiet "src/${SERVICE}/chart/values.yaml"; then
            git add "src/${SERVICE}/chart/values.yaml"
            git commit -m "ðŸš€ Update ${SERVICE} Helm chart to ${TAG} - ECR: retail-store-${SERVICE} - Commit: ${{ github.sha }}"
            git push
          fi

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect_changes, deploy]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** gitops" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect_changes.outputs.has-changes }}" == "true" ]; then
            echo "**Services deployed:** ${{ needs.detect_changes.outputs.changed-services }}" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Deployment completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** â­ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
